---
layout: post
title: Iptime 2000AU Manjaro Linux에서 인식시키기
subtitle: 삽질기
tags: [writeup]
comments: true
---

필자는 원래 데스크탑에 윈도우를 깔아서 쓰고 있었는데, 갑자기 Manjaro를 데스크탑에 설치하고 싶어졌다. 그래서 부팅용 USB를 구워서 잘 설치하고 이것저것 툴들을 설치하기 위해 ``pacman``을 실행했는데, 그 순간 콘솔에 에러들의 향연이 발생하는 것이었다. 왜 그런가 에러메세지를 보니, 필자의 방에는 랜선이 들어오지 않아 iptime사의 무선 랜 동글인 2000AU를 꽂아서 사용하고 있었는데, 만자로가 이 디바이스를 인식하지 못한 것이었다!
  
그래서 인터넷도 안되는 데스크탑을 붙잡고 씨름을 잠깐 하다 핸드폰으로 구글신께 여쭤봤다. 그러자 2000AU의 칩셋인 Realtek 8812au의 드라이버를 설치하면 된다는 계시가 내려왔다. 이 드라이버는 커널 안에 포함되어 있지 않아 따로 모듈 형식으로 빌드해서 적재해야된다는것까지 알아냈다.  
그래서 데스크탑을 끄고, 윈도우를 켜서 rtl8812au 소스를 깃헙에서 찾아 다운받은 다음 다시 데스크탑을 재부팅하고 만자로에서 윈도우 드라이브를 마운트 한다음 드라이버 소스를 복사해왔다.  
``make``를 통해 빌드하는데 에러가 또 엄청나게 난다. 이런, 커널 헤더가 없어서 빌드가 안되는 것이었다. 인터넷이 되는 환경이라면 ``sudo pacman -S linuxXX-headers``로 쉽게 설치할 수 있었겠지만 안타깝게도 인터넷이 되지 않는 환경이었고, 뭔가 방법이 없을까 고민하다 커널 소스를 가져다가 ``/lib/modules/5.4.39-1-MANJARO/build/``에 커널 소스를 통채로 박아버리기로 헀다.  
다시 데스크탑을 재부팅하고 윈도우를 켜고... (이하생략) 어떻게 어떻게 커널 5.4.39 소스를 받아다가 폴더에 넣고 다시 드라이버 폴더로 와서 빌드하니 빌드가 잘 된다!
이제 modprobe로 모듈을 적재하면...  
```modprobe: ERROR: could not insert '8812au': Exec format error```  
뭔가가 잘못되었다. dmesg를 확인해보니 vermagic이 달라서 일어난 일이었다. 실제로 도는 커널의 vermagic은 5.4.23-1-MANJORO 인데 비해 빌드된 모듈의 vermagic은 5.4.23이기 때문에 적재에 실패한 것이었다. 그래서 modprobe에 --force-vermagic 옵션을 줘보기도 하고 .../build의 커널의 Makefile을 수정해보기도 했지만 계속 Exec format error가 뜨면서 적재에 실패하였다.  
  
그래서 결국은 만자로 커널 헤더 패키지를 옮겨서 pacman -U로 설치하기로 했다. 결국 윈도우에서 가상머신에 만자로를 설치하고 [패키지](https://gitlab.manjaro.org/packages/core/linux54/-/tree/7f2067fdfa11b911e07432357b206a2f4a3736f7)를 받은 다음 ``makepkg``로 패키지를 빌드해주었다. 이 과정은 커널 빌드를 해야되서 상당히 오래 걸리는데, 처음 시도에서 링크의 git 링크를 가져다가 클론으로 받은 뒤 패키지를 빌드했더니 5.4.23이 아니라 5.4.40이 빌드되버려서 시간이 상당히 낭비되었다.  
  
이런 저런 시도 끝에 결국 인터넷도 안되는 로컬 머신에 커널 헤더까지 설치하고 드디어 rtl8812au 드라이버를 빌드하고 모듈 적재까지 했는데... 어쨰서인지 여전히 인터넷이 안된다. ``ip link``로 인터페이스를 확인해 보니 무선 인터페이스가 안잡히고 있다. 혹시 usb가 인식이 안된건가 해서 usb-devices로 확인도 해보고... 혹시 재부팅이 필요한가 해서 재부팅도 해보았지만 여전히 인식이 안된다. 그래서 dmesg를 다시 확인해봤더니 드라이버가 패닉이 뜨면서 에러 메세지를 띄우는것을 확인할 수가 있었다. 처음에 사용한 드라이버는 [여기](https://github.com/abperiasamy/rtl8812AU_8821AU_linux)에서 가져온 건데, 깃헙 이슈를 보니 5.x 이상에서 동일한 이슈가 발생한다는 사람이 있었다.  
그래서 다른 드라이버 소스를 사용하기로 하고, [여기](https://github.com/gnab/rtl8812au.git)를 사용하기로 했다. 다시 데스크탑을 끄고, 윈도우를 켜서...  
아무튼 이 소스를 가져와서 빌드한다음 modprobe로 설치했더니 무선 인터페이스가 잘 잡혀서 인터넷에 접속하는데에 성공했다! 하지만 pacman으로 업데이트를 하니 커널 버전도 올라가서 결국 한번 더 빌드해야되는 상황이 있었지만, 어쩄든 이제 인터넷이 잘 되서 이 글을 쓰고 있다.
  

세줄 요약
* 커널 헤더 설치
* rtl8812au (혹은 자신의 장치에 맞는) 드라이버 소스 받아다가 빌드 후 설치 (https://github.com/gnab/rtl8812au.git 추천)
* 반드시 인터넷이 되는 환경에서 진행할 것